<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¯HTML VADè¯­éŸ³æ£€æµ‹ç¤ºä¾‹</title>
    <!-- åŠ è½½VADåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.27/dist/bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .listening {
            background: #dc3545;
        }
        .recording {
            background: #28a745;
        }
        .transcription {
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>çº¯HTML VADè¯­éŸ³æ£€æµ‹ç¤ºä¾‹</h1>
    
    <div class="container">
        <h2>VADçŠ¶æ€</h2>
        <div id="vadStatus" class="status loading">
            ğŸ”„ æ­£åœ¨åŠ è½½VADåº“...
        </div>
        <div id="vadInfo"></div>
    </div>

    <div class="container">
        <h2>è¯­éŸ³æ£€æµ‹æ§åˆ¶</h2>
        <button id="startBtn" onclick="startVAD()" disabled>å¼€å§‹ç›‘å¬1</button>
        <button id="stopBtn" onclick="stopVAD()" disabled>åœæ­¢ç›‘å¬</button>
        <button id="clearBtn" onclick="clearTranscription()">æ¸…ç©ºç»“æœ</button>
        
        <div class="status" id="listeningStatus">æœªç›‘å¬</div>
        <div class="status" id="recordingStatus">æœªå½•åˆ¶</div>
    </div>

    <div class="container">
        <h2>è¯†åˆ«ç»“æœ</h2>
        <div id="transcription" class="transcription">
            è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
    </div>

    <div class="container">
        <h2>è°ƒè¯•ä¿¡æ¯</h2>
        <button onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        <div id="debugInfo"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let vadInstance = null;
        let isListening = false;
        let isRecording = false;
        let transcriptionText = '';

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–VAD
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–VAD...');
            initVAD();
        };

        // åˆå§‹åŒ–VAD
        function initVAD() {
            console.log('æ£€æŸ¥window.vadå¯¹è±¡...');
            
            // æ£€æŸ¥VADåº“æ˜¯å¦å·²åŠ è½½
            if (window.vad && window.vad.MicVAD) {
                console.log('âœ… VADåº“å·²åŠ è½½å®Œæˆ');
                updateVADStatus('ready', 'âœ… VADå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨');
                enableControls();
                showVADInfo();
            } else {
                console.log('â³ VADåº“è¿˜åœ¨åŠ è½½ä¸­...');
                updateVADStatus('loading', 'ğŸ”„ VADåº“åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                setTimeout(initVAD, 500);
            }
        }

        // æ›´æ–°VADçŠ¶æ€æ˜¾ç¤º
        function updateVADStatus(status, message) {
            const statusDiv = document.getElementById('vadStatus');
            statusDiv.className = 'status ' + status;
            statusDiv.innerHTML = message;
        }

        // æ˜¾ç¤ºVADä¿¡æ¯
        function showVADInfo() {
            const infoDiv = document.getElementById('vadInfo');
            infoDiv.innerHTML = `
                <div style="margin-top: 10px;">
                    <strong>VADåº“ä¿¡æ¯:</strong><br>
                    - åº“åç§°: ${window.vad ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}<br>
                    - MicVADç±»: ${window.vad && window.vad.MicVAD ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}<br>
                    - ç‰ˆæœ¬: 0.0.27 (é€šè¿‡CDNåŠ è½½)<br>
                    - ONNX Runtime: 1.22.0
                </div>
            `;
        }

        // å¯ç”¨æ§åˆ¶æŒ‰é’®
        function enableControls() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        // å¼€å§‹VADç›‘å¬
        async function startVAD() {
            if (!window.vad || !window.vad.MicVAD) {
                alert('VADåº“è¿˜æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                return;
            }

            try {
                console.log('å¼€å§‹åˆ›å»ºVADå®ä¾‹...');

                // åˆ›å»ºVADå®ä¾‹ - æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œä¸éœ€è¦æ˜¾å¼ä¼ é€’stream
                vadInstance = await window.vad.MicVAD.new({
                    onSpeechStart: () => {
                        console.log('ğŸ¤ æ£€æµ‹åˆ°è¯­éŸ³å¼€å§‹');
                        isRecording = true;
                        updateRecordingStatus('ğŸ”´ æ­£åœ¨å½•åˆ¶è¯­éŸ³');
                    },
                    onSpeechEnd: (audioData) => {
                        console.log('â¹ï¸ æ£€æµ‹åˆ°è¯­éŸ³ç»“æŸ');
                        isRecording = false;
                        updateRecordingStatus('âšª è¯­éŸ³ç»“æŸ');
                        
                        // å¤„ç†å½•åˆ¶çš„éŸ³é¢‘æ•°æ®
                        if (audioData && audioData.length > 0) {
                            console.log(`éŸ³é¢‘æ•°æ®é•¿åº¦: ${audioData.length}`);
                            processAudioData(audioData);
                        } else {
                            console.warn('VADæ²¡æœ‰æä¾›éŸ³é¢‘æ•°æ®');
                        }
                    },
                    onnxWASMBasePath: "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/",
                    baseAssetPath: "https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.27/dist/"
                });

                // å¼€å§‹ç›‘å¬
                vadInstance.start();
                isListening = true;
                updateListeningStatus('ğŸ§ æ­£åœ¨ç›‘å¬è¯­éŸ³...');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                console.log('VADç›‘å¬å·²å¯åŠ¨');
                
            } catch (error) {
                console.error('å¯åŠ¨VADå¤±è´¥:', error);
                updateVADStatus('error', 'âŒ VADå¯åŠ¨å¤±è´¥: ' + error.message);
                alert('å¯åŠ¨è¯­éŸ³æ£€æµ‹å¤±è´¥: ' + error.message);
            }
        }

        // åœæ­¢VADç›‘å¬
        function stopVAD() {
            if (vadInstance) {
                vadInstance.pause();
                vadInstance = null;
            }
            
            isListening = false;
            isRecording = false;
            
            updateListeningStatus('æœªç›‘å¬');
            updateRecordingStatus('æœªå½•åˆ¶');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            console.log('VADç›‘å¬å·²åœæ­¢');
        }

        // æ›´æ–°ç›‘å¬çŠ¶æ€
        function updateListeningStatus(message) {
            const statusDiv = document.getElementById('listeningStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (isListening ? 'listening' : '');
        }

        // æ›´æ–°å½•åˆ¶çŠ¶æ€
        function updateRecordingStatus(message) {
            const statusDiv = document.getElementById('recordingStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (isRecording ? 'recording' : '');
        }

        // å¤„ç†éŸ³é¢‘æ•°æ®å¹¶ä¿å­˜ä¸ºWAVæ–‡ä»¶
        function processAudioData(audioData) {
            console.log('å¤„ç†éŸ³é¢‘æ•°æ®...');
            
            // å°†Float32ArrayéŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºWAVæ ¼å¼
            const wavBlob = audioDataToWav(audioData);
            
            // åˆ›å»ºéŸ³é¢‘URLç”¨äºæ’­æ”¾
            const audioUrl = URL.createObjectURL(wavBlob);
            
            // ç”Ÿæˆæ–‡ä»¶åï¼ˆæ—¶é—´æˆ³ï¼‰
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `vad-recording-${timestamp}.wav`;
            
            // æ›´æ–°è¯†åˆ«ç»“æœåŒºåŸŸï¼Œæ·»åŠ éŸ³é¢‘æ’­æ”¾å™¨å’Œä¸‹è½½é“¾æ¥
            const audioPlayerHtml = `
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <strong>å½•éŸ³ ${new Date().toLocaleString()}:</strong><br>
                    <audio controls style="width: 100%; margin: 5px 0;">
                        <source src="${audioUrl}" type="audio/wav">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                    </audio>
                    <br>
                    <a href="${audioUrl}" download="${fileName}" style="color: #007bff; text-decoration: none;">
                        ğŸ“¥ ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
                    </a>
                    <span style="color: #666; margin-left: 10px;">
                        æ—¶é•¿: ${(audioData.length / 16000).toFixed(2)}ç§’
                    </span>
                </div>
            `;
            
            // æ·»åŠ åˆ°è½¬å½•åŒºåŸŸ
            const transcriptionDiv = document.getElementById('transcription');
            transcriptionDiv.innerHTML = audioPlayerHtml + transcriptionDiv.innerHTML;
            
            console.log('éŸ³é¢‘æ–‡ä»¶å·²ç”Ÿæˆ:', fileName);
            console.log('éŸ³é¢‘æ—¶é•¿:', (audioData.length / 16000).toFixed(2), 'ç§’');
        }
        
        // å°†Float32ArrayéŸ³é¢‘æ•°æ®è½¬æ¢ä¸ºWAVæ ¼å¼
        function audioDataToWav(audioData) {
            const sampleRate = 16000; // VADä½¿ç”¨16kHzé‡‡æ ·ç‡
            const numChannels = 1;   // å•å£°é“
            
            // è®¡ç®—WAVæ–‡ä»¶å¤§å°
            const buffer = new ArrayBuffer(44 + audioData.length * 2);
            const view = new DataView(buffer);
            
            // WAVæ–‡ä»¶å¤´
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + audioData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, audioData.length * 2, true);
            
            // å†™å…¥éŸ³é¢‘æ•°æ®ï¼ˆ16ä½PCMï¼‰
            let offset = 44;
            for (let i = 0; i < audioData.length; i++) {
                const sample = Math.max(-1, Math.min(1, audioData[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå†™å…¥å­—ç¬¦ä¸²åˆ°DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // æ¸…ç©ºè¯†åˆ«ç»“æœ
        function clearTranscription() {
            transcriptionText = '';
            document.getElementById('transcription').innerHTML = 'è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
            console.log('è¯†åˆ«ç»“æœå·²æ¸…ç©º');
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `
                <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
                    - window.vad: ${window.vad ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰'}<br>
                    - window.vad.MicVAD: ${window.vad && window.vad.MicVAD ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}<br>
                    - vadInstance: ${vadInstance ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'}<br>
                    - isListening: ${isListening}<br>
                    - isRecording: ${isRecording}<br>
                    - éŸ³é¢‘é‡‡æ ·ç‡: 16000Hz<br>
                    - å½“å‰æ—¶é—´: ${new Date().toLocaleString()}
                </div>
            `;
        }

        // é”™è¯¯å¤„ç†
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('å…¨å±€é”™è¯¯:', message, 'at', source, 'line', lineno);
            updateVADStatus('error', 'âŒ å‘ç”Ÿé”™è¯¯: ' + message);
        };
    </script>
</body>
</html>