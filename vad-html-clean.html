<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>纯HTML VAD语音检测示例</title>
    <!-- 加载VAD库 -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.27/dist/bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .listening {
            background: #dc3545;
        }
        .recording {
            background: #28a745;
        }
        .transcription {
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>纯HTML VAD语音检测示例</h1>
    
    <div class="container">
        <h2>VAD状态</h2>
        <div id="vadStatus" class="status loading">
            🔄 正在加载VAD库...
        </div>
        <div id="vadInfo"></div>
    </div>

    <div class="container">
        <h2>语音检测控制</h2>
        <button id="startBtn" onclick="startVAD()" disabled>开始监听1</button>
        <button id="stopBtn" onclick="stopVAD()" disabled>停止监听</button>
        <button id="clearBtn" onclick="clearTranscription()">清空结果</button>
        
        <div class="status" id="listeningStatus">未监听</div>
        <div class="status" id="recordingStatus">未录制</div>
    </div>

    <div class="container">
        <h2>识别结果</h2>
        <div id="transcription" class="transcription">
            识别结果将显示在这里...
        </div>
    </div>

    <div class="container">
        <h2>调试信息</h2>
        <button onclick="showDebugInfo()">显示调试信息</button>
        <div id="debugInfo"></div>
    </div>

    <script>
        // 全局变量
        let vadInstance = null;
        let isListening = false;
        let isRecording = false;
        let transcriptionText = '';

        // 页面加载时初始化VAD
        window.onload = function() {
            console.log('页面加载完成，开始初始化VAD...');
            initVAD();
        };

        // 初始化VAD
        function initVAD() {
            console.log('检查window.vad对象...');
            
            // 检查VAD库是否已加载
            if (window.vad && window.vad.MicVAD) {
                console.log('✅ VAD库已加载完成');
                updateVADStatus('ready', '✅ VAD已就绪，可以开始使用');
                enableControls();
                showVADInfo();
            } else {
                console.log('⏳ VAD库还在加载中...');
                updateVADStatus('loading', '🔄 VAD库加载中，请稍候...');
                
                // 等待一段时间后重试
                setTimeout(initVAD, 500);
            }
        }

        // 更新VAD状态显示
        function updateVADStatus(status, message) {
            const statusDiv = document.getElementById('vadStatus');
            statusDiv.className = 'status ' + status;
            statusDiv.innerHTML = message;
        }

        // 显示VAD信息
        function showVADInfo() {
            const infoDiv = document.getElementById('vadInfo');
            infoDiv.innerHTML = `
                <div style="margin-top: 10px;">
                    <strong>VAD库信息:</strong><br>
                    - 库名称: ${window.vad ? '已加载' : '未加载'}<br>
                    - MicVAD类: ${window.vad && window.vad.MicVAD ? '可用' : '不可用'}<br>
                    - 版本: 0.0.27 (通过CDN加载)<br>
                    - ONNX Runtime: 1.22.0
                </div>
            `;
        }

        // 启用控制按钮
        function enableControls() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        // 开始VAD监听
        async function startVAD() {
            if (!window.vad || !window.vad.MicVAD) {
                alert('VAD库还未加载完成，请稍后再试');
                return;
            }

            try {
                console.log('开始创建VAD实例...');

                // 创建VAD实例 - 根据官方文档，不需要显式传递stream
                vadInstance = await window.vad.MicVAD.new({
                    onSpeechStart: () => {
                        console.log('🎤 检测到语音开始');
                        isRecording = true;
                        updateRecordingStatus('🔴 正在录制语音');
                    },
                    onSpeechEnd: (audioData) => {
                        console.log('⏹️ 检测到语音结束');
                        isRecording = false;
                        updateRecordingStatus('⚪ 语音结束');
                        
                        // 处理录制的音频数据
                        if (audioData && audioData.length > 0) {
                            console.log(`音频数据长度: ${audioData.length}`);
                            processAudioData(audioData);
                        } else {
                            console.warn('VAD没有提供音频数据');
                        }
                    },
                    onnxWASMBasePath: "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/",
                    baseAssetPath: "https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.27/dist/"
                });

                // 开始监听
                vadInstance.start();
                isListening = true;
                updateListeningStatus('🎧 正在监听语音...');
                
                // 更新按钮状态
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                console.log('VAD监听已启动');
                
            } catch (error) {
                console.error('启动VAD失败:', error);
                updateVADStatus('error', '❌ VAD启动失败: ' + error.message);
                alert('启动语音检测失败: ' + error.message);
            }
        }

        // 停止VAD监听
        function stopVAD() {
            if (vadInstance) {
                vadInstance.pause();
                vadInstance = null;
            }
            
            isListening = false;
            isRecording = false;
            
            updateListeningStatus('未监听');
            updateRecordingStatus('未录制');
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            console.log('VAD监听已停止');
        }

        // 更新监听状态
        function updateListeningStatus(message) {
            const statusDiv = document.getElementById('listeningStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (isListening ? 'listening' : '');
        }

        // 更新录制状态
        function updateRecordingStatus(message) {
            const statusDiv = document.getElementById('recordingStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (isRecording ? 'recording' : '');
        }

        // 处理音频数据并保存为WAV文件
        function processAudioData(audioData) {
            console.log('处理音频数据...');
            
            // 将Float32Array音频数据转换为WAV格式
            const wavBlob = audioDataToWav(audioData);
            
            // 创建音频URL用于播放
            const audioUrl = URL.createObjectURL(wavBlob);
            
            // 生成文件名（时间戳）
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `vad-recording-${timestamp}.wav`;
            
            // 更新识别结果区域，添加音频播放器和下载链接
            const audioPlayerHtml = `
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <strong>录音 ${new Date().toLocaleString()}:</strong><br>
                    <audio controls style="width: 100%; margin: 5px 0;">
                        <source src="${audioUrl}" type="audio/wav">
                        您的浏览器不支持音频播放
                    </audio>
                    <br>
                    <a href="${audioUrl}" download="${fileName}" style="color: #007bff; text-decoration: none;">
                        📥 下载音频文件
                    </a>
                    <span style="color: #666; margin-left: 10px;">
                        时长: ${(audioData.length / 16000).toFixed(2)}秒
                    </span>
                </div>
            `;
            
            // 添加到转录区域
            const transcriptionDiv = document.getElementById('transcription');
            transcriptionDiv.innerHTML = audioPlayerHtml + transcriptionDiv.innerHTML;
            
            console.log('音频文件已生成:', fileName);
            console.log('音频时长:', (audioData.length / 16000).toFixed(2), '秒');
        }
        
        // 将Float32Array音频数据转换为WAV格式
        function audioDataToWav(audioData) {
            const sampleRate = 16000; // VAD使用16kHz采样率
            const numChannels = 1;   // 单声道
            
            // 计算WAV文件大小
            const buffer = new ArrayBuffer(44 + audioData.length * 2);
            const view = new DataView(buffer);
            
            // WAV文件头
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + audioData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, audioData.length * 2, true);
            
            // 写入音频数据（16位PCM）
            let offset = 44;
            for (let i = 0; i < audioData.length; i++) {
                const sample = Math.max(-1, Math.min(1, audioData[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }
        
        // 辅助函数：写入字符串到DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // 清空识别结果
        function clearTranscription() {
            transcriptionText = '';
            document.getElementById('transcription').innerHTML = '识别结果将显示在这里...';
            console.log('识别结果已清空');
        }

        // 显示调试信息
        function showDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `
                <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>调试信息:</strong><br>
                    - window.vad: ${window.vad ? '已定义' : '未定义'}<br>
                    - window.vad.MicVAD: ${window.vad && window.vad.MicVAD ? '可用' : '不可用'}<br>
                    - vadInstance: ${vadInstance ? '已创建' : '未创建'}<br>
                    - isListening: ${isListening}<br>
                    - isRecording: ${isRecording}<br>
                    - 音频采样率: 16000Hz<br>
                    - 当前时间: ${new Date().toLocaleString()}
                </div>
            `;
        }

        // 错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('全局错误:', message, 'at', source, 'line', lineno);
            updateVADStatus('error', '❌ 发生错误: ' + message);
        };
    </script>
</body>
</html>